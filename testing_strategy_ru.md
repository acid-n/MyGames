# Стратегия Тестирования Проекта "Alien Invasion"

## 1. Цели Тестирования

Основными целями внедрения и применения автоматизированного тестирования в проекте "Alien Invasion" являются:

*   **Повышение качества кода:** Снижение количества ошибок и регрессий при внесении изменений или добавлении нового функционала.
*   **Обеспечение стабильности:** Гарантия того, что ключевые механики игры работают корректно после каждого изменения.
*   **Ускорение разработки:** Быстрая обратная связь от тестов позволяет раньше выявлять проблемы, сокращая время на отладку.
*   **Упрощение рефакторинга:** Наличие тестов придает уверенность при изменении существующего кода, так как они помогают убедиться, что функциональность не была нарушена.
*   **Документирование кода:** Тесты служат живой документацией, демонстрирующей, как должны работать отдельные компоненты и система в целом.
*   **Проверка корректности управления ассетами:** Уверенность в том, что все необходимые игровые ресурсы (изображения, звуки) доступны и корректно загружаются.

## 2. Типы Тестов и их Применение

### 2.1. Модульные тесты (Unit Tests)

*   **Фокус:** Тестирование наименьших изолированных частей кода – отдельных функций, методов классов. Цель – проверить корректность логики конкретного модуля, изолировав его от зависимостей (с помощью мок-объектов).
*   **Применение в "Alien Invasion":**
    *   **Примеры (уже созданы):**
        *   `TestSettingsInitialization` (`tests/test_game_logic.py`): Проверка инициализации класса `Settings`, корректности путей к ассетам, локализованных строк и вспомогательных функций.
        *   `TestShipLoading` (`tests/test_game_logic.py`): Проверка создания объекта `Ship` и загрузки его ресурсов.
        *   `TestScoreboardUpdates` (`tests/test_game_logic.py`): Проверка обновления информации в `Scoreboard`.
        *   `TestGameStats` (`tests/test_game_logic.py`): Проверка логики загрузки и сохранения рекордов в `GameStats`.
        *   `TestButtonCreation` (`tests/test_game_logic.py`): Проверка создания кнопки и корректности отображения текста. Были добавлены тесты для проверки логики `is_clicked()` (попадание в кнопку, мимо, на границе).
    *   **Рекомендации по расширению:**
        *   Тестирование методов расчета в `Settings` (например, `calculate_alien_speed`, `calculate_shield_spawn_chance`).
        *   Углубленное тестирование логики движения и состояний в `Ship` (например, проверка границ экрана после движения).
        *   Тестирование логики `PowerUp` (если она усложнится, например, разные эффекты при столкновении).
        *   Тестирование `Starfield` и `SpaceObject` для проверки их инициализации и логики обновления.

### 2.2. Интеграционные тесты (Integration Tests)

*   **Фокус:** Проверка взаимодействия между несколькими компонентами системы. Цель – убедиться, что модули корректно работают вместе.
*   **Применение в "Alien Invasion" (реализованы в `tests/test_integration_and_state.py`):**
    *   **`TestGameStatsAndScoreboardIntegration`**: Проверяет интеграцию `GameStats` и `Scoreboard`. Тестирует, как изменения в `GameStats` (счет, уровень, рекорд, количество кораблей) корректно обрабатываются и отображаются в `Scoreboard`. Использует реальный `Scoreboard` с реальной инициализацией `pygame.font`, но мокирует загрузку изображений.
    *   **`TestAlienFleetCreation`**: Тестирует логику создания флота пришельцев в `AlienInvasion._create_fleet`. Проверяет правильность расчета количества пришельцев и рядов, а также механизм назначения бонусов пришельцам на разных уровнях игры. Использует реальный `AlienInvasion` с мокнутыми Pygame-зависимостями.
    *   **`TestShipAndBulletInteraction`**: Проверяет взаимодействие корабля и пуль. Включает тесты на одиночный и двойной выстрел (проверка количества пуль и их начальных позиций), а также на ограничение количества одновременно существующих пуль.
    *   **`TestBulletAlienCollisionLogic`**: Тестирует логику столкновения пуль с пришельцами. Проверяет удаление объектов, обновление счета и статистики, а также создание объекта `PowerUp` при уничтожении пришельца с назначенным бонусом.
    *   **`TestShipPowerUpCollisionLogic`**: Проверяет взаимодействие корабля с бонусами. Включает тесты на подбор бонусов 'щит' и 'двойной огонь' (активация соответствующих флагов на корабле, установка времени активации) и на корректное истечение времени действия этих бонусов.
    *   **`TestAlienInvasionStateManagement`**: Тестирует управление основными состояниями игры (`MENU`, `PLAYING`, `PAUSED`, `GAME_OVER`) в классе `AlienInvasion`. Проверяет переходы между состояниями в ответ на действия пользователя (нажатия клавиш `ESC`, `P`) и игровые события (потеря последнего корабля), а также корректную работу кнопок в меню и меню паузы.
    *   **`TestAlienLogic`**: Тестирует логику класса `Alien`, в частности методы `check_edges` (проверка достижения края экрана) и `update` (корректность движения пришельца в зависимости от направления флота и скорости).
    *   **Общие подходы:** В интеграционных тестах активно используются реальные экземпляры тестируемых классов с мокированием только внешних зависимостей (например, Pygame API) для проверки их совместной работы.

### 2.3. Тесты ассетов (Asset Tests)

*   **Фокус:** Специализированные тесты для проверки фактического наличия файлов ассетов по путям, указанным в `Settings`, и их базовой корректности.
*   **Применение в "Alien Invasion":**
    *   **Проверка наличия:** Для каждого пути к ассету в `Settings` (изображения, звуки) выполнить `os.path.exists(path)`.
    *   **Проверка загрузки изображений:** Попытаться загрузить каждое изображение с помощью `pygame.image.load(path)`. Если загрузка не удалась, тест провален. Это поможет выявить поврежденные файлы или файлы неподдерживаемого формата на ранней стадии. (Требует инициализации `pygame.display` или использования `pygame.image.get_extended()` и соответствующей обработки).
    *   **Проверка загрузки звуков:** Аналогично для звуков с `pygame.mixer.Sound(path)`. (Требует инициализации `pygame.mixer`).
    *   Эти тесты могут быть выделены в отдельную группу и запускаться, например, перед сборкой дистрибутива или при изменении ассетов.

### 2.4. Тесты пользовательского интерфейса (UI Tests) / Сквозные тесты (End-to-End Tests)

*   **Фокус:** Для игр на Pygame полная автоматизация UI-тестов затруднительна без специализированных инструментов, которые могут "видеть" экран и имитировать ввод пользователя. Однако, можно реализовать частичные проверки.
*   **Применение в "Alien Invasion":**
    *   Частично покрыто `TestAlienInvasionStateManagement` в части реакции на события (клики, нажатия клавиш) и смены состояний.
    *   **Проверка видимости элементов:** Проверить, что в определенных состояниях игры нужные кнопки или элементы интерфейса (например, текст "Пауза") становятся "видимыми" (т.е. их методы `draw` или `blit` вызываются). Это можно сделать путем мокирования методов отрисовки и проверки, были ли они вызваны.
    *   **Next.js (гипотетически):** Если бы в проекте была веб-часть на Next.js (например, для таблицы лидеров онлайн или настроек), то для нее применялись бы стандартные инструменты веб-тестирования:
        *   **Jest с React Testing Library:** Для модульного и интеграционного тестирования React-компонентов.
        *   **Cypress или Playwright:** Для сквозных тестов, имитирующих действия пользователя в браузере.

## 3. Инструменты и Фреймворки

*   **Python:**
    *   **`unittest`:** (Уже используется) Встроенный в Python фреймворк, хорошо подходит для начала. Обеспечивает базовый функционал для написания тестов (классы тестов, методы-тесты, утверждения, `setUp/tearDown`).
    *   **`pytest`:** (Рекомендация для рассмотрения) Сторонний фреймворк, предлагающий более гибкий и менее шаблонный синтаксис для написания тестов. Имеет множество плагинов (например, `pytest-cov` для покрытия кода, `pytest-mock` для удобной работы с моками). Может упростить написание и организацию тестов, особенно для интеграционных.
*   **Мокирование:**
    *   **`unittest.mock`:** (Активно используется) Мощный инструмент для создания мок-объектов и заглушек, позволяющий изолировать тестируемый код от его зависимостей. Успешно применен `patch` (как декоратор и как менеджер контекста) для мокирования модулей Pygame (`pygame.event.get`, `pygame.mouse.set_visible`, `pygame.time.get_ticks`, `pygame.mixer`, `pygame.font` и др.), методов классов (`Scoreboard.prep_score`, `AlienInvasion._start_new_game`) и `sys.exit`.
    *   **Вспомогательные функции для моков:** В `tests/test_integration_and_state.py` созданы и используются функции `setup_pygame_mocks` и `teardown_pygame_mocks`. Рекомендуется придерживаться такого подхода для инкапсуляции повторяющейся логики настройки и сброса моков, особенно для сложных зависимостей, таких как Pygame. Это улучшает читаемость тестов и упрощает их поддержку.
*   **Next.js (гипотетически, для веб-части):**
    *   **`Jest`:** Популярный фреймворк для тестирования JavaScript, часто используется с React.
    *   **`React Testing Library`:** Библиотека для тестирования React-компонентов, поощряющая написание тестов, ориентированных на поведение пользователя.
    *   **`Cypress` / `Playwright`:** Инструменты для сквозного тестирования веб-приложений в реальном браузере.

## 4. Стратегии Мокирования Pygame и Рекомендации по Написанию Тестов

При написании тестов для игры на Pygame важно правильно управлять инициализацией и мокированием модулей Pygame для обеспечения изоляции и стабильности тестов.

*   **Полное мокирование по умолчанию:** Для большинства модульных и многих интеграционных тестов, где не требуется реальный рендеринг или взаимодействие с окном, рекомендуется полное мокирование соответствующих модулей Pygame (`pygame.display`, `pygame.image`, `pygame.transform`, `pygame.mixer`, `pygame.font` на уровне `SysFont`). Это предотвращает ошибки типа `No video mode has been set` и ускоряет выполнение тестов. Вспомогательные классы (`MockSurface`, `MockRect`, `MockPygameFont` и т.д.) и функции (`setup_pygame_mocks`) помогают в этом.
*   **Частичная реальная инициализация (при необходимости):**
    *   **Пример с `pygame.font`:** Для тестов, проверяющих корректность рендеринга текста (например, в `TestGameStatsAndScoreboardIntegration` для `Scoreboard`), необходимо инициализировать реальный `pygame.font` (`pygame.font.init()`). При этом остальные модули Pygame (особенно `pygame.display`) могут и должны оставаться мокнутыми, если их реальная работа не требуется. Важно аккуратно управлять состоянием: инициализировать `pygame.font` в `setUpClass` или `setUp`, а затем восстанавливать исходное состояние или моки в `tearDown` или `tearDownClass`.
    *   **Изоляция:** Даже при частичной реальной инициализации важно не допускать создания реальных окон или звукового вывода, которые могут мешать тестовому окружению. Мокирование `pygame.display.set_mode` и `pygame.mixer.Sound().play` помогает этого избежать.
*   **Изоляция состояния Pygame:** Состояние Pygame (инициализированные модули, загруженные ресурсы) является глобальным. Тесты должны быть написаны так, чтобы минимизировать влияние друг на друга. Использование `setUp` и `tearDown` (или `setUpClass`/`tearDownClass`) для настройки и сброса моков, а также очистки загруженных ресурсов моками (например, `MockPygameImage.clear_expected_surfaces()`) критически важно.
*   **Независимость (Isolation):** Каждый тест должен быть независим от других. Результат одного теста не должен влиять на результат другого.
*   **Скорость (Fast):** Модульные тесты должны выполняться быстро.
*   **Одна проверка на тест (Single Responsibility):** Каждый тестовый метод должен проверять один конкретный аспект.
*   **Понятные имена (Descriptive Names):** Имена тестовых методов должны четко описывать, что они проверяют.
*   **AAA (Arrange, Act, Assert):** Структурируйте тесты по этому паттерну.
*   **Читаемость:** Тесты – это тоже код. Они должны быть чистыми и понятными.
*   **Русский язык:** Все текстовые материалы, связанные с тестами, должны быть на русском языке.

## 5. Приоритеты Тестирования

Текущее покрытие тестами значительно улучшилось, особенно для ключевой игровой логики и управления состояниями. Приоритеты остаются актуальными, с акцентом на:

1.  **Критически важная игровая логика:** (Значительно покрыто)
    *   Управление состояниями игры (`AlienInvasion.game_state`).
    *   Подсчет очков и статистика (`GameStats`, `Scoreboard`).
    *   Управление жизнями и завершение игры.
    *   Взаимодействие объектов (корабль, пули, пришельцы, бонусы).
2.  **Загрузка и управление ассетами:** (Частично покрыто через `TestSettingsInitialization`, но специализированные тесты ассетов все еще актуальны).
3.  **Основные игровые механики:** (Значительно покрыто)
    *   Движение корабля и пришельцев.
    *   Стрельба.
    *   Коллизии.
    *   Бонусы.
4.  **Динамическое изменение сложности:** (Требует большего внимания).
5.  **Новый или изменяемый функционал:** Любой новый код должен сопровождаться тестами.

## 6. Покрытие Кода (Code Coverage)

*   **Цель:** Измерить, какая часть кода выполняется во время запуска тестов.
*   **Инструменты:** `coverage.py` (с `unittest` или `pytest`), `pytest-cov`.
*   **Целевые показатели:** 70-80% для ключевых модулей, 85-95% для критически важных частей.
*   **Анализ отчетов:** Регулярно анализировать для выявления нетестированных участков.

## 7. Интеграция в Процесс Разработки

*   **Локальный запуск тестов:** Разработчики должны запускать тесты локально перед коммитами.
    *   **Pre-commit хуки:** Рекомендуется настроить для автоматического запуска тестов.
*   **CI/CD (Continuous Integration / Continuous Delivery):**
    *   Автоматический запуск тестов при пушах / Pull Request.
    *   Генерация отчетов о покрытии.

## 8. Дальнейшие Шаги и Рекомендации

*   **Переход на `pytest`:** Подтверждается рекомендация рассмотреть переход на `pytest` для более удобного синтаксиса, управления фикстурами и плагинами (например, `pytest-mock`, `pytest-cov`). Это может упростить написание и поддержку тестов, особенно для сложных сценариев мокирования и интеграционных тестов.
*   **Параметризация тестов:** Для тестирования схожих сценариев с разными входными данными (например, разные типы бонусов, разные позиции для проверки коллизий) активно использовать параметризацию тестов. `pytest` предоставляет очень удобные механизмы для этого (`@pytest.mark.parametrize`).
*   **Тестирование `Starfield` и `SpaceObject`:** Написать тесты для классов `Starfield` (проверка логики обновления, отрисовки – возможно, через мокирование `pygame.draw`) и `SpaceObject` (проверка инициализации, движения, затухания).
*   **Тесты ассетов:** Реализовать специализированные тесты для проверки наличия и базовой корректности загрузки всех ассетов.
*   **Углубленное тестирование `Settings`:** Добавить тесты для функций динамического расчета сложности (`calculate_alien_speed`, `get_powerup_drop_rate_for_level` и т.п.).
*   **Регулярный пересмотр стратегии:** Данная стратегия должна регулярно пересматриваться и обновляться по мере развития проекта и накопления опыта в тестировании Pygame-приложений.

Эта стратегия тестирования обеспечивает основу для создания надежной и качественной игры "Alien Invasion". Она должна регулярно пересматриваться и адаптироваться по мере развития проекта.
